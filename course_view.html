<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Course - LearnSphere AI</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <a href="index.html" class="logo">LearnSphere AI</a>
            <nav>
                <a href="index.html">New Course</a>
                </nav>
        </div>
    </header>

    <main class="container">
        <h1 id="course-main-title" style="text-align: center; color: var(--primary-color); margin-bottom: 30px;">
            Loading Your Personalized Course...
        </h1>
        <div class="error-message" id="error-message-course"></div>

        <div class="course-view-layout">
            <aside class="course-sidebar" id="course-sidebar">
                <h3>Course Outline</h3>
                <div class="loading-indicator active" id="sidebar-loading">Loading outline...</div>
                <ul id="lesson-list-ul">
                    </ul>
            </aside>

            <section class="course-content-area">
                <h2 id="lesson-title-display" class="lesson-title-display">Select a lesson to begin</h2>
                <div class="loading-indicator" id="lesson-loading"></div>
                <div class="lesson-content" id="lesson-content-display">
                    <p>Your lesson content will appear here once generated.</p>
                </div>

                <div class="interaction-bar">
                    <button class="btn" id="thumbs-up-btn" style="display:none;">üëç I Understood This</button>
                    <button class="btn btn-secondary" id="expand-topic-btn" style="display:none;">‚ûï Expand on Selected Text</button>
                </div>
                <div id="expanded-content-area" style="display:none; margin-top: 20px; padding:15px; background-color: #e9ecef; border-radius: 5px;">
                    </div>

                <div class="quiz-section" id="quiz-section" style="display:none;">
                    <h3>Check Your Understanding</h3>
                    <div id="quiz-questions-container">
                        </div>
                    <button class="btn" id="submit-quiz-btn" style="display:none;">Submit Quiz Answers</button>
                </div>

                <div class="course-nav-buttons" style="display:none;">
                    <button class="btn btn-secondary" id="prev-lesson-btn">‚Üê Previous Lesson</button>
                    <button class="btn" id="next-lesson-btn">Next Lesson ‚Üí</button>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 LearnSphere AI. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // --- Global Variables (Retrieved from localStorage) ---
        let GEMINI_API_KEY = '';
        let USER_LEARNING_GOAL = '';
        let USER_EXPERTISE_LEVEL = '';
        let USER_LEARNING_REASON = '';
        let COURSE_STRUCTURE = null; // Will hold the parsed course structure
        let currentLessonIndex = { module: -1, lesson: -1 };

        // --- DOM Elements ---
        const courseMainTitle = document.getElementById('course-main-title');
        const lessonListUl = document.getElementById('lesson-list-ul');
        const lessonTitleDisplay = document.getElementById('lesson-title-display');
        const lessonContentDisplay = document.getElementById('lesson-content-display');
        const sidebarLoading = document.getElementById('sidebar-loading');
        const lessonLoading = document.getElementById('lesson-loading');
        const errorMessageCourse = document.getElementById('error-message-course');
        const expandTopicBtn = document.getElementById('expand-topic-btn');
        const expandedContentArea = document.getElementById('expanded-content-area');

        // Quiz elements (to be implemented more fully later)
        const quizSection = document.getElementById('quiz-section');
        const quizQuestionsContainer = document.getElementById('quiz-questions-container');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');

        // Interaction buttons to show/hide
        const thumbsUpBtn = document.getElementById('thumbs-up-btn');
        const courseNavButtons = document.querySelector('.course-nav-buttons');


        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            GEMINI_API_KEY = localStorage.getItem('geminiApiKey');
            USER_LEARNING_GOAL = localStorage.getItem('userLearningGoal');
            USER_EXPERTISE_LEVEL = localStorage.getItem('userExpertiseLevel');
            USER_LEARNING_REASON = localStorage.getItem('userLearningReason');
            const storedStructure = localStorage.getItem('generatedCourseStructure');

            if (!GEMINI_API_KEY || !storedStructure || !USER_LEARNING_GOAL) {
                showError("Course data not found or API key missing. Please generate a course first.");
                courseMainTitle.textContent = "Error Loading Course";
                sidebarLoading.classList.remove('active');
                return;
            }

            try {
                COURSE_STRUCTURE = JSON.parse(storedStructure);
                if (COURSE_STRUCTURE && COURSE_STRUCTURE.courseTitle) {
                     courseMainTitle.textContent = COURSE_STRUCTURE.courseTitle;
                } else {
                    courseMainTitle.textContent = `Personalized Course on "${USER_LEARNING_GOAL}"`; // Fallback title
                }
                populateSidebar();
            } catch (e) {
                showError("Failed to parse course structure. Please try generating the course again.");
                console.error("Parsing error:", e);
                sidebarLoading.classList.remove('active');
            }
        });

        function populateSidebar() {
            if (!COURSE_STRUCTURE || !COURSE_STRUCTURE.modules) {
                showError("Invalid course structure received.");
                sidebarLoading.classList.remove('active');
                return;
            }

            lessonListUl.innerHTML = ''; // Clear any existing
            COURSE_STRUCTURE.modules.forEach((module, moduleIndex) => {
                const moduleLi = document.createElement('li');
                moduleLi.className = 'module-title';
                moduleLi.textContent = module.title;
                lessonListUl.appendChild(moduleLi);

                if (module.lessons && module.lessons.length > 0) {
                    module.lessons.forEach((lesson, lessonIndexInModule) => {
                        const lessonLi = document.createElement('li');
                        const lessonLink = document.createElement('a');
                        lessonLink.href = '#';
                        lessonLink.textContent = lesson.title;
                        lessonLink.dataset.moduleIndex = moduleIndex;
                        lessonLink.dataset.lessonIndex = lessonIndexInModule;
                        lessonLink.addEventListener('click', handleLessonLinkClick);
                        lessonLi.appendChild(lessonLink);
                        lessonListUl.appendChild(lessonLi);
                    });
                }
            });
            sidebarLoading.classList.remove('active');
             // Auto-load the first lesson if available
            if (COURSE_STRUCTURE.modules.length > 0 && COURSE_STRUCTURE.modules[0].lessons.length > 0) {
                const firstLessonLink = lessonListUl.querySelector('a[data-module-index="0"][data-lesson-index="0"]');
                if (firstLessonLink) {
                    firstLessonLink.click();
                }
            } else {
                 lessonTitleDisplay.textContent = "No lessons found in this course.";
            }
        }

        async function handleLessonLinkClick(event) {
            event.preventDefault();
            hideMessages();
            const targetLink = event.target;
            const moduleIndex = parseInt(targetLink.dataset.moduleIndex);
            const lessonIndexInModule = parseInt(targetLink.dataset.lessonIndex);

            currentLessonIndex = { module: moduleIndex, lesson: lessonIndexInModule };

            // Highlight active lesson
            document.querySelectorAll('#lesson-list-ul a').forEach(link => link.classList.remove('active'));
            targetLink.classList.add('active');

            const lessonObj = COURSE_STRUCTURE.modules[moduleIndex].lessons[lessonIndexInModule];
            lessonTitleDisplay.textContent = lessonObj.title;
            lessonContentDisplay.innerHTML = ''; // Clear previous content
            expandedContentArea.style.display = 'none'; // Hide expanded content
            quizSection.style.display = 'none'; // Hide quiz
            quizQuestionsContainer.innerHTML = '';

            lessonLoading.classList.add('active');
            showInteractionButtons(false);


            // --- Prompt for Lesson Content ---
            const lessonPrompt = `You are an AI Tutor. The user is learning about "${USER_LEARNING_GOAL}" (expertise: ${USER_EXPERTISE_LEVEL}, reason: "${USER_LEARNING_REASON}").
Generate the full lesson content for the lesson titled: "${lessonObj.title}".
The content should be informative, engaging, well-structured with paragraphs, and suitable for the user's expertise level.
Use clear headings (e.g., ## Sub-heading) within the lesson content if appropriate.
Explain concepts clearly. If the user is a beginner, avoid overly complex jargon or explain it well.
Format the output as plain text with markdown-like headings (##) for structure. Do not wrap in JSON.`;

            try {
                const lessonContentText = await callGeminiAPIForText(GEMINI_API_KEY, lessonPrompt);
                // Basic Markdown to HTML conversion (only for ## headings)
                let htmlContent = lessonContentText
                    .replace(/^## (.*$)/gim, '<h3>$1</h3>') // H2 in markdown -> H3 in HTML
                    .replace(/\n/g, '<br>'); // Newlines to <br>

                lessonContentDisplay.innerHTML = htmlContent;

                showInteractionButtons(true);

                // Optionally, generate quiz after lesson content is loaded
                await generateAndDisplayQuiz(lessonObj.title, lessonContentText);

            } catch (error) {
                console.error("Error generating lesson content:", error);
                showError(`Failed to load lesson: ${error.message}`);
                lessonContentDisplay.innerHTML = `<p>Could not load lesson content. Please try again.</p>`;
            } finally {
                lessonLoading.classList.remove('active');
            }
        }

        async function generateAndDisplayQuiz(lessonTitle, lessonContextText) {
            quizSection.style.display = 'none';
            quizQuestionsContainer.innerHTML = '';
            submitQuizBtn.style.display = 'none';

            const quizPrompt = `Based on the following lesson content for "${lessonTitle}":
---
${lessonContextText.substring(0, 3000)}
---
Generate 2-3 multiple-choice quiz questions to test understanding. Each question should have 3 options (A, B, C).
Indicate the correct answer (A, B, or C).
Output this as a valid JSON object with the structure:
{
  "quizTitle": "Quiz for ${lessonTitle}",
  "questions": [
    {
      "questionText": "What is...",
      "options": ["Option A text", "Option B text", "Option C text"],
      "correctOptionLetter": "A"
    }
  ]
}
Ensure the JSON is valid.`;

            try {
                const quizData = await callGeminiAPI(GEMINI_API_KEY, quizPrompt); // callGeminiAPI parses JSON

                if (quizData && quizData.questions && quizData.questions.length > 0) {
                    quizSection.style.display = 'block';
                    quizData.questions.forEach((q, index) => {
                        const questionDiv = document.createElement('div');
                        questionDiv.className = 'quiz-question';
                        questionDiv.innerHTML = `
                            <p>${index + 1}. ${q.questionText}</p>
                            ${q.options.map((opt, optIndex) => `
                                <label>
                                    <input type="radio" name="q${index}" value="${String.fromCharCode(65 + optIndex)}">
                                    ${String.fromCharCode(65 + optIndex)}. ${opt}
                                </label>
                            `).join('')}
                            <div class="quiz-feedback" id="q${index}-feedback"></div>
                        `;
                        // Store correct answer for later checking
                        questionDiv.dataset.correct = q.correctOptionLetter;
                        quizQuestionsContainer.appendChild(questionDiv);
                    });
                    if (quizData.questions.length > 0) submitQuizBtn.style.display = 'block';
                }
            } catch (error) {
                console.warn("Could not generate quiz:", error);
                // Don't show a blocking error for quiz failure, just skip it.
            }
        }


        expandTopicBtn.addEventListener('click', async () => {
            hideMessages();
            const selectedText = window.getSelection().toString().trim();
            let topicToExpand = selectedText;

            if (!topicToExpand) {
                 // If no text selected, try to use the current lesson title or a prominent part of it
                const currentLessonTitle = lessonTitleDisplay.textContent;
                if (!currentLessonTitle || currentLessonTitle === "Select a lesson to begin") {
                    showError("Please select some text from the lesson to expand upon, or load a lesson first.");
                    return;
                }
                topicToExpand = `the main concepts of the lesson: "${currentLessonTitle}"`;
            }


            expandedContentArea.innerHTML = "<i>Expanding topic... Please wait.</i>";
            expandedContentArea.style.display = 'block';

            const expandPrompt = `You are an AI Tutor. The user is learning about "${USER_LEARNING_GOAL}" (expertise: ${USER_EXPERTISE_LEVEL}).
They are currently in a lesson titled "${lessonTitleDisplay.textContent}".
The user wants to expand on the following specific topic or selected text: "${topicToExpand}".
Provide a concise but more detailed explanation, or give examples related to this selected topic in the context of the current lesson.
Format the output as plain text. Do not wrap in JSON.`;

            try {
                const expandedText = await callGeminiAPIForText(GEMINI_API_KEY, expandPrompt);
                expandedContentArea.innerHTML = `<p><strong>Expanded Explanation:</strong></p><p>${expandedText.replace(/\n/g, '<br>')}</p>`;
            } catch (error) {
                console.error("Error expanding topic:", error);
                expandedContentArea.innerHTML = `<p style="color:red;">Could not expand topic: ${error.message}</p>`;
            }
        });

        submitQuizBtn.addEventListener('click', () => {
            const questions = quizQuestionsContainer.querySelectorAll('.quiz-question');
            questions.forEach((qDiv, index) => {
                const selectedOption = qDiv.querySelector(`input[name="q${index}"]:checked`);
                const feedbackDiv = document.getElementById(`q${index}-feedback`);
                if (selectedOption) {
                    if (selectedOption.value === qDiv.dataset.correct) {
                        feedbackDiv.textContent = "Correct!";
                        feedbackDiv.className = 'quiz-feedback correct';
                    } else {
                        feedbackDiv.textContent = `Incorrect. The correct answer was ${qDiv.dataset.correct}.`;
                        feedbackDiv.className = 'quiz-feedback incorrect';
                    }
                } else {
                    feedbackDiv.textContent = "Please select an answer.";
                    feedbackDiv.className = 'quiz-feedback';
                }
            });
        });

        // --- Helper: Call Gemini API (expects JSON response) ---
        async function callGeminiAPI(apiKey, promptText) {
             // Using v1beta - make sure this model is available or switch to a GA version like gemini-1.5-flash-latest
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const requestBody = {
                contents: [{ parts: [{ text: promptText }] }],
                generationConfig: { responseMimeType: "application/json" }
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`API request failed: ${errorBody.error?.message || response.statusText}`);
            }
            const responseData = await response.json();
            if (responseData.candidates?.[0]?.content?.parts?.[0]?.text) {
                try {
                    return JSON.parse(responseData.candidates[0].content.parts[0].text);
                } catch (e) {
                    console.error("Failed to parse JSON from Gemini (expected JSON):", responseData.candidates[0].content.parts[0].text, e);
                    throw new Error("Gemini response was not valid JSON when JSON was expected.");
                }
            } else {
                console.error("Invalid API response structure (expected JSON):", responseData);
                throw new Error('Received an invalid API response structure (expected JSON).');
            }
        }

        // --- Helper: Call Gemini API (expects Text response) ---
        async function callGeminiAPIForText(apiKey, promptText) {
            // Using v1beta - make sure this model is available or switch to a GA version like gemini-1.5-flash-latest
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const requestBody = {
                contents: [{ parts: [{ text: promptText }] }]
                // No specific responseMimeType, default is usually text for simple prompts
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`API request failed: ${errorBody.error?.message || response.statusText}`);
            }
            const responseData = await response.json();
            if (responseData.candidates?.[0]?.content?.parts?.[0]?.text) {
                return responseData.candidates[0].content.parts[0].text;
            } else {
                console.error("Invalid API response structure (expected text):", responseData);
                throw new Error('Received an invalid API response structure (expected text).');
            }
        }


        function showError(message) {
            errorMessageCourse.textContent = message;
            errorMessageCourse.classList.add('active');
        }
        function hideMessages(){
            errorMessageCourse.classList.remove('active');
            // lessonLoading.classList.remove('active'); // Control this more granularly
        }
        function showInteractionButtons(show) {
            const displayStyle = show ? 'inline-block' : 'none';
            thumbsUpBtn.style.display = displayStyle;
            expandTopicBtn.style.display = displayStyle;
            courseNavButtons.style.display = show ? 'flex' : 'none';
        }

    </script>
</body>
</html>